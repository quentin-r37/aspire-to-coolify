# aspire2coolify

[![CI](https://github.com/quentin-r37/aspire-to-coolify/actions/workflows/ci.yml/badge.svg?branch=main)](https://github.com/quentin-r37/aspire-to-coolify/actions/workflows/ci.yml)
[![npm version](https://img.shields.io/npm/v/aspire2coolify.svg)](https://www.npmjs.com/package/aspire2coolify)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![semantic-release](https://img.shields.io/badge/semantic--release-angular-e10079?logo=semantic-release)](https://github.com/semantic-release/semantic-release)

CLI tool to convert .NET Aspire configurations to Coolify deployments using the Coolify REST API.

## Installation

```bash
npm install -g aspire2coolify
```

Or run locally:

```bash
npm install
npm run build
```

## Quick Start

```bash
# 1. Initialize config file
aspire2coolify init

# 2. Set your Coolify credentials
export COOLIFY_API_URL=https://coolify.example.com
export COOLIFY_TOKEN=your-api-token

# 3. Deploy your Aspire app
aspire2coolify deploy ./AppHost/Program.cs \
  --project-id your-project-uuid \
  --server-id your-server-uuid \
  --environment-name production
```

## Usage

### Parse Command

Parse an Aspire Program.cs file and display the extracted model:

```bash
aspire2coolify parse ./AppHost/Program.cs

# Output to file
aspire2coolify parse ./AppHost/Program.cs -o model.json
```

### Generate Command

Generate a bash script with curl commands to deploy via the Coolify API:

```bash
aspire2coolify generate ./AppHost/Program.cs

# Output to file
aspire2coolify generate ./AppHost/Program.cs -o deploy.sh

# With Coolify project/server IDs baked into the script
aspire2coolify generate ./AppHost/Program.cs \
  --project-id proj-123 \
  --server-id srv-456 \
  --environment-name production

# Output as JSON (API payloads)
aspire2coolify generate ./AppHost/Program.cs --json
```

### Deploy Command

Deploy directly to Coolify via the REST API:

```bash
# Set credentials via environment variables (recommended)
export COOLIFY_API_URL=https://coolify.example.com
export COOLIFY_TOKEN=your-api-token

# Dry run (shows what would be deployed)
aspire2coolify deploy ./AppHost/Program.cs --dry-run \
  --project-id proj-123 \
  --server-id srv-456 \
  --environment-name production

# Execute deployment
aspire2coolify deploy ./AppHost/Program.cs \
  --project-id proj-123 \
  --server-id srv-456 \
  --environment-name production

# Deploy and start resources immediately
aspire2coolify deploy ./AppHost/Program.cs \
  --project-id proj-123 \
  --server-id srv-456 \
  --environment-name production \
  --instant-deploy
```

#### Deploy Options

| Option | Description |
|--------|-------------|
| `--api-url <url>` | Coolify API URL (or use `COOLIFY_API_URL` env var) |
| `--token <token>` | Coolify API token (or use `COOLIFY_TOKEN` env var) |
| `--project-id <id>` | Coolify project UUID |
| `--server-id <id>` | Coolify server UUID |
| `--environment-name <name>` | Environment name (e.g., `production`, `staging`) |
| `--instant-deploy` | Deploy resources immediately after creation |
| `--dry-run` | Preview deployment without executing |

### Init Command

Create a configuration file:

```bash
aspire2coolify init
```

## Example

### Input (Program.cs)

```csharp
var builder = DistributedApplication.CreateBuilder(args);

var postgres = builder.AddAzurePostgresFlexibleServer("postgreServer")
    .RunAsContainer(a => a
        .WithImage("pgvector/pgvector")
        .WithImageTag("pg17")
        .WithDataVolume()
        .WithHostPort(5432)
    );
var db = postgres.AddDatabase("db");

builder.AddNpmApp("svelte", "../VibeCode.SvelteKit")
    .WithEnvironment("BODY_SIZE_LIMIT", "10M")
    .WithHttpEndpoint(env: "PORT")
    .WithReference(db)
    .PublishAsDockerFile();

builder.Build().Run();
```

### Output (Coolify API Script)

```bash
#!/bin/bash
# Generated by aspire2coolify
# Coolify API deployment script
#
# Required environment variables:
#   COOLIFY_API_URL - Your Coolify instance URL (e.g., https://coolify.example.com)
#   COOLIFY_TOKEN   - Your Coolify API token
#
# Usage:
#   export COOLIFY_API_URL=https://coolify.example.com
#   export COOLIFY_TOKEN=your-api-token
#   ./deploy.sh

set -e

# Validate environment variables
if [ -z "$COOLIFY_API_URL" ]; then
  echo "Error: COOLIFY_API_URL environment variable is not set"
  exit 1
fi

if [ -z "$COOLIFY_TOKEN" ]; then
  echo "Error: COOLIFY_TOKEN environment variable is not set"
  exit 1
fi

echo "Deploying to Coolify at $COOLIFY_API_URL"
echo ""

# Database: postgreServer (postgres)
echo "Creating postgreServer..."
curl -X POST "${COOLIFY_API_URL}/api/v1/databases/postgresql" \
  -H "Authorization: Bearer ${COOLIFY_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "server_uuid": "${SERVER_UUID}",
    "project_uuid": "${PROJECT_UUID}",
    "environment_name": "${ENVIRONMENT_NAME}",
    "name": "postgreServer",
    "image": "pgvector/pgvector:pg17",
    "is_public": true,
    "public_port": 5432,
    "instant_deploy": true
  }'
echo ""

# Application: svelte (npm)
echo "Creating svelte..."
curl -X POST "${COOLIFY_API_URL}/api/v1/applications/dockerimage" \
  -H "Authorization: Bearer ${COOLIFY_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "server_uuid": "${SERVER_UUID}",
    "project_uuid": "${PROJECT_UUID}",
    "environment_name": "${ENVIRONMENT_NAME}",
    "docker_registry_image_name": "svelte",
    "docker_registry_image_tag": "latest",
    "name": "svelte",
    "ports_exposes": "80",
    "instant_deploy": false
  }'
echo ""

echo "Deployment complete!"
```

## Configuration

Create an `aspire2coolify.config.js` file:

```javascript
export default {
  coolify: {
    // API connection
    apiUrl: 'https://coolify.example.com',
    token: 'your-api-token', // Or use COOLIFY_TOKEN env var (recommended)

    // Deployment target
    projectId: 'your-project-uuid',
    serverId: 'your-server-uuid',
    environmentName: 'production',
  },
  defaults: {
    buildPack: 'nixpacks',
  },
  output: {
    includeComments: true,
    format: 'shell', // 'shell' | 'json'
  },
};
```

### Environment Variables

| Variable | Description |
|----------|-------------|
| `COOLIFY_API_URL` | Your Coolify instance URL |
| `COOLIFY_TOKEN` | Your Coolify API token (from Keys & Tokens in Coolify) |

### Credential Priority

Credentials are resolved in this order (highest to lowest priority):

1. CLI flags (`--api-url`, `--token`)
2. Environment variables (`COOLIFY_API_URL`, `COOLIFY_TOKEN`)
3. Config file (`coolify.apiUrl`, `coolify.token`)
4. Interactive prompt (for token, if running in a TTY)

## Supported Aspire Methods

### Databases
- `AddPostgres`, `AddAzurePostgresFlexibleServer`
- `AddSqlServer`, `AddAzureSqlServer`
- `AddMySql`
- `AddMongoDB`
- `AddRedis`

### Services
- `AddRabbitMQ`
- `AddKafka`
- `AddKeycloak`
- `AddSeq`
- `AddMailDev`
- `AddElasticsearch`

### Storage
- `AddMinioContainer`

### Applications
- `AddNpmApp`, `AddNodeApp`, `AddJavaScriptApp`
- `AddProject<T>`
- `AddDockerfile`
- `AddContainer`

### Configuration Methods
- `WithEnvironment(key, value)`
- `WithReference(resource)`
- `WaitFor(resource)`
- `WithHttpEndpoint()`, `WithHttpsEndpoint()`
- `WithExternalHttpEndpoints()`
- `WithHostPort(port)`
- `WithImage(image)`, `WithImageTag(tag)`
- `WithDataVolume()`
- `WithRunScript(scriptName)`
- `WithNpm(installCommand: "ci")`
- `PublishAsDockerFile()`
- `RunAsContainer()`

## API Reference

This tool uses the [Coolify REST API](https://coolify.io/docs/api-reference/api/) to create and manage resources:

| Resource | API Endpoint |
|----------|--------------|
| PostgreSQL | `POST /api/v1/databases/postgresql` |
| MySQL | `POST /api/v1/databases/mysql` |
| MongoDB | `POST /api/v1/databases/mongodb` |
| Redis | `POST /api/v1/databases/redis` |
| Services | `POST /api/v1/services` |
| Applications | `POST /api/v1/applications/dockerimage` |

## Development

```bash
# Install dependencies
npm install

# Build
npm run build

# Run tests
npm test

# Watch mode
npm run dev

# Lint
npm run lint
```

## License

MIT
