# aspire2coolify

[![CI](https://github.com/quentin-r37/aspire-to-coolify/actions/workflows/ci.yml/badge.svg?branch=main)](https://github.com/quentin-r37/aspire-to-coolify/actions/workflows/ci.yml)
[![npm version](https://img.shields.io/npm/v/aspire2coolify.svg)](https://www.npmjs.com/package/aspire2coolify)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![semantic-release](https://img.shields.io/badge/semantic--release-angular-e10079?logo=semantic-release)](https://github.com/semantic-release/semantic-release)

CLI tool to convert .NET Aspire configurations to Coolify CLI commands.

## Installation

```bash
npm install -g aspire2coolify
```

Or run locally:

```bash
npm install
npm run build
```

## Usage

### Parse Command

Parse an Aspire Program.cs file and display the extracted model:

```bash
aspire2coolify parse ./AppHost/Program.cs

# Output to file
aspire2coolify parse ./AppHost/Program.cs -o model.json
```

### Generate Command

Generate Coolify CLI commands from an Aspire Program.cs file:

```bash
aspire2coolify generate ./AppHost/Program.cs

# Output to file
aspire2coolify generate ./AppHost/Program.cs -o deploy.sh

# With Coolify project/server IDs
aspire2coolify generate ./AppHost/Program.cs \
  --project-id proj-123 \
  --server-id srv-456

# Output as JSON
aspire2coolify generate ./AppHost/Program.cs --json
```

### Deploy Command

Parse and execute Coolify commands (requires `coolify` CLI to be installed):

```bash
# Dry run (shows commands without executing)
aspire2coolify deploy ./AppHost/Program.cs --dry-run

# Execute commands
aspire2coolify deploy ./AppHost/Program.cs
```

### Init Command

Create a configuration file:

```bash
aspire2coolify init
```

## Example

### Input (Program.cs)

```csharp
var builder = DistributedApplication.CreateBuilder(args);

var postgres = builder.AddAzurePostgresFlexibleServer("postgreServer")
    .RunAsContainer(a => a
        .WithImage("pgvector/pgvector")
        .WithImageTag("pg17")
        .WithDataVolume()
        .WithHostPort(5432)
    );
var db = postgres.AddDatabase("db");

builder.AddNpmApp("svelte", "../VibeCode.SvelteKit")
    .WithEnvironment("BODY_SIZE_LIMIT", "10M")
    .WithHttpEndpoint(env: "PORT")
    .WithReference(db)
    .PublishAsDockerFile();

builder.Build().Run();
```

### Output (Coolify Commands)

```bash
#!/bin/bash
# Generated by aspire2coolify

# Database: postgreServer (postgres)
coolify \
  database:create \
  --name "postgreServer" \
  --type postgres \
  --image "pgvector/pgvector:pg17" \
  --public-port 5432

# Database: db (postgres)
coolify \
  database:create \
  --name "db" \
  --type postgres

# Application: svelte (npm)
coolify \
  application:create \
  --name "svelte" \
  --build-pack dockerfile \
  --source "../VibeCode.SvelteKit" \
  --env "BODY_SIZE_LIMIT=10M" \
  --env "DATABASE_URL=${db.connectionString}" \
  --env "PORT=3000"
```

## Configuration

Create an `aspire2coolify.config.js` file:

```javascript
export default {
  coolify: {
    projectId: 'your-project-id',
    serverId: 'your-server-id',
    environmentId: 'your-environment-id',
  },
  defaults: {
    buildPack: 'nixpacks',
  },
  output: {
    includeComments: true,
    format: 'shell',
  },
};
```

## Supported Aspire Methods

### Databases
- `AddPostgres`, `AddAzurePostgresFlexibleServer`
- `AddSqlServer`, `AddAzureSqlServer`
- `AddMySql`
- `AddMongoDB`
- `AddRedis`

### Services
- `AddRabbitMQ`
- `AddKafka`
- `AddKeycloak`
- `AddSeq`
- `AddMailDev`
- `AddElasticsearch`

### Storage
- `AddMinioContainer`

### Applications
- `AddNpmApp`, `AddNodeApp`, `AddJavaScriptApp`
- `AddProject<T>`
- `AddDockerfile`
- `AddContainer`

### Configuration Methods
- `WithEnvironment(key, value)`
- `WithReference(resource)`
- `WaitFor(resource)`
- `WithHttpEndpoint()`, `WithHttpsEndpoint()`
- `WithExternalHttpEndpoints()`
- `WithHostPort(port)`
- `WithImage(image)`, `WithImageTag(tag)`
- `WithDataVolume()`
- `WithRunScript(scriptName)`
- `WithNpm(installCommand: "ci")`
- `PublishAsDockerFile()`
- `RunAsContainer()`

## Development

```bash
# Install dependencies
npm install

# Build
npm run build

# Run tests
npm test

# Watch mode
npm run dev
```
